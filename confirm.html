<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ã‚±é… - æ³¨æ–‡ç¢ºèª</title>
    
    <!-- PWAå¯¾å¿œ -->
    <meta name="description" content="æ–™ç†ã‚‚ã€ã¨ãã‚ãã‚‚ã€ä¸€ç·’ã«å±Šã‘ã¾ã™ã€‚ã‚¤ã‚±ãƒ¡ãƒ³é…é”å“¡ã‚’æŒ‡åã§ãã‚‹æ–°æ„Ÿè¦šãƒ‡ãƒªãƒãƒªãƒ¼ã‚¢ãƒ—ãƒªã€‚">
    <meta name="theme-color" content="#ff6b9d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ã‚¤ã‚±é…">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="logo">ğŸš´ ã‚¤ã‚±é… Ikehai</h1>
                    <p class="tagline">ã¨ãã‚ãé…é”ã€å±Šã‘ã¾ã™</p>
                </div>
                <div class="header-right">
                    <a href="shop.html" class="shop-link">ğŸ›ï¸ ã‚·ãƒ§ãƒƒãƒ—</a>
                </div>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <div class="container">
            <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
            <div class="step-indicator">
                <div class="step completed">
                    <span class="step-number">1</span>
                    <span class="step-label">æ–™ç†é¸æŠ</span>
                </div>
                <div class="step-line"></div>
                <div class="step completed">
                    <span class="step-number">2</span>
                    <span class="step-label">é…é”å“¡é¸æŠ</span>
                </div>
                <div class="step-line"></div>
                <div class="step active">
                    <span class="step-number">3</span>
                    <span class="step-label">æ³¨æ–‡ç¢ºèª</span>
                </div>
            </div>

            <section class="intro-section">
                <h2>æ³¨æ–‡å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</h2>
            </section>

            <!-- æ³¨æ–‡ç¢ºèªã‚«ãƒ¼ãƒ‰ -->
            <div class="confirm-container">
                <div class="confirm-card">
                    <h3>ğŸ“¦ ã”æ³¨æ–‡å†…å®¹</h3>
                    <div id="orderDetails" class="order-details">
                        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>

                <div class="confirm-card">
                    <h3>ğŸš´ æ‹…å½“é…é”å“¡</h3>
                    <div id="riderDetails" class="rider-details">
                        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>
            
            <!-- æ–™é‡‘æ˜ç´°ã‚«ãƒ¼ãƒ‰ -->
            <div class="price-summary-card">
                <h3>ğŸ’° æ–™é‡‘æ˜ç´°</h3>
                <div id="priceSummary" class="price-summary">
                    <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="window.location.href='riders.html'">
                    â† é…é”å“¡ã‚’é¸ã³ç›´ã™
                </button>
                <button class="btn btn-primary btn-large" onclick="confirmOrder()">
                    æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹ âœ¨
                </button>
            </div>

            <!-- æ³¨æ–‡å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆéè¡¨ç¤ºï¼‰ -->
            <div id="orderModal" class="modal">
                <div class="modal-content">
                    <div class="modal-icon">ğŸ‰</div>
                    <h2>æ³¨æ–‡ãŒç¢ºå®šã—ã¾ã—ãŸï¼</h2>
                    <div class="rider-coming">
                        <img id="modalRiderImage" src="" alt="é…é”å“¡" class="rider-avatar">
                        <p class="rider-message">
                            <span id="modalRiderName"></span>ã•ã‚“ãŒ<br>
                            ã‚ãªãŸã®ã‚‚ã¨ã¸å‘ã‹ã£ã¦ã„ã¾ã™ï¼
                        </p>
                        <div class="rider-message-box">
                            <p id="modalRiderGreeting" class="modal-greeting"></p>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <p class="eta">äºˆå®šåˆ°ç€æ™‚åˆ»: ç´„30åˆ†</p>
                    <button class="btn btn-primary" onclick="goToTracking()">
                        é…é”çŠ¶æ³ã‚’è¦‹ã‚‹ ğŸ“
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="footer">
        <p>&copy; 2025 Ikehai - All Rights Reserved</p>
    </footer>

    <script src="js/data.js"></script>
    <script src="js/script.js"></script>
    <script>
        let menuData = [];
        let ridersData = [];

        // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§æ³¨æ–‡å†…å®¹ã‚’è¡¨ç¤º
        function loadOrderDetails() {
            try {
                // data.jsã‹ã‚‰ç›´æ¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                menuData = getMenuData();
                ridersData = getRidersData();

                displayOrderDetails();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        }

        // æ³¨æ–‡è©³ç´°ã‚’è¡¨ç¤º
        function displayOrderDetails() {
            const menuId = parseInt(localStorage.getItem('selectedMenuId'));
            const riderId = parseInt(localStorage.getItem('selectedRiderId'));

            const selectedMenu = menuData.find(item => item.id === menuId);
            const selectedRider = ridersData.find(rider => rider.id === riderId);

            if (!selectedMenu || !selectedRider) {
                window.location.href = 'index.html';
                return;
            }

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è©³ç´°ã‚’è¡¨ç¤º
            document.getElementById('orderDetails').innerHTML = `
                <div class="detail-item">
                    <img src="${selectedMenu.image}" alt="${selectedMenu.name}" class="detail-image">
                    <div class="detail-info">
                        <h4>${selectedMenu.name}</h4>
                        <p>${selectedMenu.description}</p>
                        <p class="price-large">Â¥${selectedMenu.price.toLocaleString()}</p>
                    </div>
                </div>
            `;

            // é…é”å“¡è©³ç´°ã‚’è¡¨ç¤º
            document.getElementById('riderDetails').innerHTML = `
                <div class="detail-item">
                    <img src="${selectedRider.image}" alt="${selectedRider.name}" class="detail-image rider-image-round">
                    <div class="detail-info">
                        <h4>${selectedRider.name}</h4>
                        <p class="rider-type">${selectedRider.type}</p>
                        <p class="rider-stats">â­ ${selectedRider.rating} | ğŸš´ ${selectedRider.deliveries}å›é…é”</p>
                        <p class="rider-quote-small">"${selectedRider.quote}"</p>
                    </div>
                </div>
                <div class="rider-greeting-box">
                    <p class="rider-greeting">ğŸ’¬ "${selectedRider.greeting}"</p>
                </div>
            `;
            
            // ä¼šå“¡æƒ…å ±ã‚’å–å¾—
            const membership = getMembershipData();
            
            // æ–™é‡‘æ˜ç´°ã‚’è¡¨ç¤º
            let deliveryFee = 300; // åŸºæœ¬é…é”æ–™
            let nominationFee = selectedRider.nominationFee; // æŒ‡åæ–™
            let serviceFee = Math.floor(selectedMenu.price * 0.1); // ã‚µãƒ¼ãƒ“ã‚¹æ‰‹æ•°æ–™ï¼ˆå•†å“ä»£é‡‘ã®10%ï¼‰
            const restaurantFee = Math.floor(selectedMenu.price * 0.15); // é£²é£Ÿåº—æ‰‹æ•°æ–™ï¼ˆå†…éƒ¨ã€è¡¨ç¤ºã¯ä»»æ„ï¼‰
            
            // ä¼šå“¡å‰²å¼•ã‚’é©ç”¨
            let discountInfo = '';
            if (membership && membership.active) {
                const discounts = membership.discounts;
                
                // ã‚µãƒ¼ãƒ“ã‚¹æ‰‹æ•°æ–™å‰²å¼•
                if (discounts.serviceFee > 0) {
                    const originalServiceFee = serviceFee;
                    serviceFee = Math.floor(serviceFee * (1 - discounts.serviceFee));
                    discountInfo += `<div class="discount-applied">ğŸ’ ã‚µãƒ¼ãƒ“ã‚¹æ‰‹æ•°æ–™ ${discounts.serviceFee * 100}%ã‚ªãƒ• (-Â¥${originalServiceFee - serviceFee})</div>`;
                }
                
                // é…é”æ–™å‰²å¼•
                if (discounts.deliveryFee > 0) {
                    const originalDeliveryFee = deliveryFee;
                    deliveryFee = Math.floor(deliveryFee * (1 - discounts.deliveryFee));
                    discountInfo += `<div class="discount-applied">ğŸ’ é…é”æ–™ ${discounts.deliveryFee * 100}%ã‚ªãƒ• (-Â¥${originalDeliveryFee - deliveryFee})</div>`;
                }
                
                // æŒ‡åæ–™å‰²å¼•
                if (discounts.nominationFee > 0) {
                    const originalNominationFee = nominationFee;
                    nominationFee = Math.floor(nominationFee * (1 - discounts.nominationFee));
                    discountInfo += `<div class="discount-applied">ğŸ’ æŒ‡åæ–™ ${discounts.nominationFee * 100}%ã‚ªãƒ• (-Â¥${originalNominationFee - nominationFee})</div>`;
                }
            }
            
            const subtotal = selectedMenu.price + deliveryFee + nominationFee + serviceFee;
            
            document.getElementById('priceSummary').innerHTML = `
                ${discountInfo}
                <div class="price-row">
                    <span>å•†å“ä»£é‡‘</span>
                    <span>Â¥${selectedMenu.price.toLocaleString()}</span>
                </div>
                <div class="price-row">
                    <span>é…é”æ–™</span>
                    <span>Â¥${deliveryFee.toLocaleString()}</span>
                </div>
                <div class="price-row">
                    <span>ã‚µãƒ¼ãƒ“ã‚¹æ‰‹æ•°æ–™ <span class="info-tooltip" title="ã‚¤ã‚±é…ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ©ç”¨æ–™">â“˜</span></span>
                    <span>Â¥${serviceFee.toLocaleString()}</span>
                </div>
                <div class="price-row price-highlight">
                    <span>ğŸ’• æŒ‡åæ–™ï¼ˆ${selectedRider.name}ã•ã‚“ï¼‰</span>
                    <span>Â¥${nominationFee.toLocaleString()}</span>
                </div>
                <div class="price-divider"></div>
                <div class="price-row price-total">
                    <span><strong>åˆè¨ˆ</strong></span>
                    <span><strong>Â¥${subtotal.toLocaleString()}</strong></span>
                </div>
                <div class="revenue-note">
                    <p class="note-text">â€»é£²é£Ÿåº—ã‹ã‚‰ã¯åˆ¥é€”æ‰‹æ•°æ–™ï¼ˆå•†å“ä»£é‡‘ã®15%ï¼‰ã‚’å¾´åã—ã¦ã„ã¾ã™</p>
                </div>
            `;
        }

        // ä¼šå“¡æƒ…å ±ã‚’å–å¾—
        function getMembershipData() {
            const data = localStorage.getItem('membership');
            return data ? JSON.parse(data) : null;
        }

        // æ³¨æ–‡ç¢ºå®šå‡¦ç†
        function confirmOrder() {
            const riderName = localStorage.getItem('selectedRiderName');
            const riderId = parseInt(localStorage.getItem('selectedRiderId'));
            const selectedRider = ridersData.find(rider => rider.id === riderId);

            if (selectedRider) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«é…é”å“¡æƒ…å ±ã‚’è¨­å®š
                document.getElementById('modalRiderName').textContent = riderName;
                document.getElementById('modalRiderImage').src = selectedRider.image;
                document.getElementById('modalRiderGreeting').textContent = `ğŸ’¬ ${selectedRider.greeting}`;
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modal = document.getElementById('orderModal');
            modal.style.display = 'flex';
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            setTimeout(() => {
                modal.querySelector('.progress-fill').style.width = '100%';
            }, 100);
        }

        // é…é”è¿½è·¡ãƒšãƒ¼ã‚¸ã¸é·ç§»
        function goToTracking() {
            window.location.href = 'tracking.html';
        }

        // è©•ä¾¡ãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼ˆè¿½è·¡ãƒšãƒ¼ã‚¸ã‹ã‚‰ä½¿ç”¨ï¼‰
        function goToRating() {
            window.location.href = 'rating.html';
        }

        // è©•ä¾¡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸
        function skipToHome() {
            if (confirm('è©•ä¾¡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ\né…é”å“¡ã®åŠ±ã¿ã«ãªã‚Šã¾ã™ã®ã§ã€ãœã²è©•ä¾¡ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚')) {
                resetOrder();
            }
        }

        // æ³¨æ–‡ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸
        function resetOrder() {
            // é¸æŠæƒ…å ±ã®ã¿ã‚¯ãƒªã‚¢ï¼ˆãŠæ°—ã«å…¥ã‚Šã¨è©•ä¾¡å±¥æ­´ã¯ä¿æŒï¼‰
            localStorage.removeItem('selectedMenuId');
            localStorage.removeItem('selectedMenuName');
            localStorage.removeItem('selectedRiderId');
            localStorage.removeItem('selectedRiderName');
            window.location.href = 'index.html';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        window.addEventListener('DOMContentLoaded', () => {
            // é¸æŠæƒ…å ±ãŒãªã„å ´åˆã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸
            if (!localStorage.getItem('selectedMenuId') || !localStorage.getItem('selectedRiderId')) {
                window.location.href = 'index.html';
                return;
            }

            loadOrderDetails();
        });
    </script>
</body>
</html>

